<?php header('Content-Type: application/json'); header("Access-Control-Allow-Origin: *"); $file = '/var/www/html/tracker/locations.json'; if (!file_exists($file)) { echo json_encode([]); exit; } $locations = json_decode(file_get_contents($file), true); if (!$locations) { echo json_encode([]); exit; } // Umbral de actividad (60 segundos) $active_threshold = 60; $active_devices = []; $current_time = time(); foreach ($locations as $device_id => $history) { if (!empty($history)) { $last = end($history); $last_timestamp = strtotime($last['timestamp']); if ($current_time - $last_timestamp <= $active_threshold) { $active_devices[$device_id] = $history; } } } if (isset($_GET['device_id'])) { $device_id = $_GET['device_id']; echo json_encode([$device_id => $active_devices[$device_id] ?? null]); } else { echo json_encode($active_devices); } ?>